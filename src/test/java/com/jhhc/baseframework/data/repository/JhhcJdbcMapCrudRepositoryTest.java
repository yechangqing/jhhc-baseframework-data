package com.jhhc.baseframework.data.repository;

import com.jhhc.baseframework.test.Base;
import static java.util.Arrays.asList;
import java.util.HashMap;
import java.util.Iterator;
import java.util.List;
import java.util.Map;
import org.junit.Test;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.data.repository.CrudRepository;
import org.springframework.jdbc.core.JdbcTemplate;
import static org.hamcrest.CoreMatchers.is;
import static org.hamcrest.CoreMatchers.notNullValue;
import static org.hamcrest.CoreMatchers.nullValue;
import static org.hamcrest.MatcherAssert.assertThat;
import static org.hamcrest.CoreMatchers.is;
import static org.hamcrest.CoreMatchers.notNullValue;
import static org.hamcrest.CoreMatchers.nullValue;
import static org.hamcrest.MatcherAssert.assertThat;
import static org.hamcrest.CoreMatchers.is;
import static org.hamcrest.CoreMatchers.notNullValue;
import static org.hamcrest.CoreMatchers.nullValue;
import static org.hamcrest.MatcherAssert.assertThat;
import static org.hamcrest.CoreMatchers.is;
import static org.hamcrest.CoreMatchers.notNullValue;
import static org.hamcrest.CoreMatchers.nullValue;
import static org.hamcrest.MatcherAssert.assertThat;
import static org.hamcrest.CoreMatchers.is;
import static org.hamcrest.CoreMatchers.notNullValue;
import static org.hamcrest.CoreMatchers.nullValue;
import static org.hamcrest.MatcherAssert.assertThat;
import static org.hamcrest.CoreMatchers.is;
import static org.hamcrest.CoreMatchers.notNullValue;
import static org.hamcrest.CoreMatchers.nullValue;
import static org.hamcrest.MatcherAssert.assertThat;
import static org.hamcrest.CoreMatchers.is;
import static org.hamcrest.CoreMatchers.notNullValue;
import static org.hamcrest.CoreMatchers.nullValue;
import static org.hamcrest.MatcherAssert.assertThat;
import static org.hamcrest.CoreMatchers.is;
import static org.hamcrest.CoreMatchers.notNullValue;
import static org.hamcrest.CoreMatchers.nullValue;
import static org.hamcrest.MatcherAssert.assertThat;
import static org.hamcrest.CoreMatchers.is;
import static org.hamcrest.CoreMatchers.notNullValue;
import static org.hamcrest.CoreMatchers.nullValue;
import static org.hamcrest.MatcherAssert.assertThat;
import static org.hamcrest.CoreMatchers.is;
import static org.hamcrest.CoreMatchers.notNullValue;
import static org.hamcrest.CoreMatchers.nullValue;
import static org.hamcrest.MatcherAssert.assertThat;
import static org.hamcrest.CoreMatchers.is;
import static org.hamcrest.CoreMatchers.notNullValue;
import static org.hamcrest.CoreMatchers.nullValue;
import static org.hamcrest.MatcherAssert.assertThat;
import static org.hamcrest.CoreMatchers.is;
import static org.hamcrest.CoreMatchers.notNullValue;
import static org.hamcrest.CoreMatchers.nullValue;
import static org.hamcrest.MatcherAssert.assertThat;
import static org.hamcrest.CoreMatchers.is;
import static org.hamcrest.CoreMatchers.notNullValue;
import static org.hamcrest.CoreMatchers.nullValue;
import static org.hamcrest.MatcherAssert.assertThat;
import static org.hamcrest.CoreMatchers.is;
import static org.hamcrest.CoreMatchers.notNullValue;
import static org.hamcrest.CoreMatchers.nullValue;
import static org.hamcrest.MatcherAssert.assertThat;
import static org.hamcrest.CoreMatchers.is;
import static org.hamcrest.CoreMatchers.notNullValue;
import static org.hamcrest.CoreMatchers.nullValue;
import static org.hamcrest.MatcherAssert.assertThat;
import static org.hamcrest.CoreMatchers.is;
import static org.hamcrest.CoreMatchers.notNullValue;
import static org.hamcrest.CoreMatchers.nullValue;
import static org.hamcrest.MatcherAssert.assertThat;
import static org.hamcrest.CoreMatchers.is;
import static org.hamcrest.CoreMatchers.notNullValue;
import static org.hamcrest.CoreMatchers.nullValue;
import static org.hamcrest.MatcherAssert.assertThat;
import static org.hamcrest.CoreMatchers.is;
import static org.hamcrest.CoreMatchers.notNullValue;
import static org.hamcrest.CoreMatchers.nullValue;
import static org.hamcrest.MatcherAssert.assertThat;
import static org.hamcrest.CoreMatchers.is;
import static org.hamcrest.CoreMatchers.notNullValue;
import static org.hamcrest.CoreMatchers.nullValue;
import static org.hamcrest.MatcherAssert.assertThat;
import static org.hamcrest.CoreMatchers.is;
import static org.hamcrest.CoreMatchers.notNullValue;
import static org.hamcrest.CoreMatchers.nullValue;
import static org.hamcrest.MatcherAssert.assertThat;
import static org.hamcrest.CoreMatchers.is;
import static org.hamcrest.CoreMatchers.notNullValue;
import static org.hamcrest.CoreMatchers.nullValue;
import static org.hamcrest.MatcherAssert.assertThat;
import static org.hamcrest.CoreMatchers.is;
import static org.hamcrest.CoreMatchers.notNullValue;
import static org.hamcrest.CoreMatchers.nullValue;
import static org.hamcrest.MatcherAssert.assertThat;
import static org.hamcrest.CoreMatchers.is;
import static org.hamcrest.CoreMatchers.notNullValue;
import static org.hamcrest.CoreMatchers.nullValue;
import static org.hamcrest.MatcherAssert.assertThat;
import static org.hamcrest.CoreMatchers.is;
import static org.hamcrest.CoreMatchers.notNullValue;
import static org.hamcrest.CoreMatchers.nullValue;
import static org.hamcrest.MatcherAssert.assertThat;
import static org.hamcrest.CoreMatchers.is;
import static org.hamcrest.CoreMatchers.notNullValue;
import static org.hamcrest.CoreMatchers.nullValue;
import static org.hamcrest.MatcherAssert.assertThat;
import static org.hamcrest.CoreMatchers.is;
import static org.hamcrest.CoreMatchers.notNullValue;
import static org.hamcrest.CoreMatchers.nullValue;
import static org.hamcrest.MatcherAssert.assertThat;
import static org.hamcrest.CoreMatchers.is;
import static org.hamcrest.CoreMatchers.notNullValue;
import static org.hamcrest.CoreMatchers.nullValue;
import static org.hamcrest.MatcherAssert.assertThat;
import static org.hamcrest.CoreMatchers.is;
import static org.hamcrest.CoreMatchers.notNullValue;
import static org.hamcrest.CoreMatchers.nullValue;
import static org.hamcrest.MatcherAssert.assertThat;
import static org.hamcrest.CoreMatchers.is;
import static org.hamcrest.CoreMatchers.notNullValue;
import static org.hamcrest.CoreMatchers.nullValue;
import static org.hamcrest.MatcherAssert.assertThat;
import static org.hamcrest.CoreMatchers.is;
import static org.hamcrest.CoreMatchers.notNullValue;
import static org.hamcrest.CoreMatchers.nullValue;
import static org.hamcrest.MatcherAssert.assertThat;
import static org.hamcrest.CoreMatchers.is;
import static org.hamcrest.CoreMatchers.notNullValue;
import static org.hamcrest.CoreMatchers.nullValue;
import static org.hamcrest.MatcherAssert.assertThat;
import static org.hamcrest.CoreMatchers.is;
import static org.hamcrest.CoreMatchers.notNullValue;
import static org.hamcrest.CoreMatchers.nullValue;
import static org.hamcrest.MatcherAssert.assertThat;
import static org.hamcrest.CoreMatchers.is;
import static org.hamcrest.CoreMatchers.notNullValue;
import static org.hamcrest.CoreMatchers.nullValue;
import static org.hamcrest.MatcherAssert.assertThat;
import static org.hamcrest.CoreMatchers.is;
import static org.hamcrest.CoreMatchers.notNullValue;
import static org.hamcrest.CoreMatchers.nullValue;
import static org.hamcrest.MatcherAssert.assertThat;
import static org.hamcrest.CoreMatchers.is;
import static org.hamcrest.CoreMatchers.notNullValue;
import static org.hamcrest.CoreMatchers.nullValue;
import static org.hamcrest.MatcherAssert.assertThat;
import static org.hamcrest.CoreMatchers.is;
import static org.hamcrest.CoreMatchers.notNullValue;
import static org.hamcrest.CoreMatchers.nullValue;
import static org.hamcrest.MatcherAssert.assertThat;
import static org.hamcrest.CoreMatchers.is;
import static org.hamcrest.CoreMatchers.notNullValue;
import static org.hamcrest.CoreMatchers.nullValue;
import static org.hamcrest.MatcherAssert.assertThat;
import static org.hamcrest.CoreMatchers.is;
import static org.hamcrest.CoreMatchers.notNullValue;
import static org.hamcrest.CoreMatchers.nullValue;
import static org.hamcrest.MatcherAssert.assertThat;
import static org.hamcrest.CoreMatchers.is;
import static org.hamcrest.CoreMatchers.notNullValue;
import static org.hamcrest.CoreMatchers.nullValue;
import static org.hamcrest.MatcherAssert.assertThat;
import static org.hamcrest.CoreMatchers.is;
import static org.hamcrest.CoreMatchers.notNullValue;
import static org.hamcrest.CoreMatchers.nullValue;
import static org.hamcrest.MatcherAssert.assertThat;
import static org.hamcrest.CoreMatchers.is;
import static org.hamcrest.CoreMatchers.notNullValue;
import static org.hamcrest.CoreMatchers.nullValue;
import static org.hamcrest.MatcherAssert.assertThat;
import static org.hamcrest.CoreMatchers.is;
import static org.hamcrest.CoreMatchers.notNullValue;
import static org.hamcrest.CoreMatchers.nullValue;
import static org.hamcrest.MatcherAssert.assertThat;
import static org.hamcrest.CoreMatchers.is;
import static org.hamcrest.CoreMatchers.notNullValue;
import static org.hamcrest.CoreMatchers.nullValue;
import static org.hamcrest.MatcherAssert.assertThat;
import static org.hamcrest.CoreMatchers.is;
import static org.hamcrest.CoreMatchers.notNullValue;
import static org.hamcrest.CoreMatchers.nullValue;
import static org.hamcrest.MatcherAssert.assertThat;
import static org.hamcrest.CoreMatchers.is;
import static org.hamcrest.CoreMatchers.notNullValue;
import static org.hamcrest.CoreMatchers.nullValue;
import static org.hamcrest.MatcherAssert.assertThat;
import static org.hamcrest.CoreMatchers.is;
import static org.hamcrest.CoreMatchers.notNullValue;
import static org.hamcrest.CoreMatchers.nullValue;
import static org.hamcrest.MatcherAssert.assertThat;
import static org.hamcrest.CoreMatchers.is;
import static org.hamcrest.CoreMatchers.notNullValue;
import static org.hamcrest.CoreMatchers.nullValue;
import static org.hamcrest.MatcherAssert.assertThat;
import static org.hamcrest.CoreMatchers.is;
import static org.hamcrest.CoreMatchers.notNullValue;
import static org.hamcrest.CoreMatchers.nullValue;
import static org.hamcrest.MatcherAssert.assertThat;
import static org.hamcrest.CoreMatchers.is;
import static org.hamcrest.CoreMatchers.notNullValue;
import static org.hamcrest.CoreMatchers.nullValue;
import static org.hamcrest.MatcherAssert.assertThat;
import static org.hamcrest.CoreMatchers.is;
import static org.hamcrest.CoreMatchers.notNullValue;
import static org.hamcrest.CoreMatchers.nullValue;
import static org.hamcrest.MatcherAssert.assertThat;
import static org.hamcrest.CoreMatchers.is;
import static org.hamcrest.CoreMatchers.notNullValue;
import static org.hamcrest.CoreMatchers.nullValue;
import static org.hamcrest.MatcherAssert.assertThat;
import static org.hamcrest.CoreMatchers.is;
import static org.hamcrest.CoreMatchers.notNullValue;
import static org.hamcrest.CoreMatchers.nullValue;
import static org.hamcrest.MatcherAssert.assertThat;
import static org.hamcrest.CoreMatchers.is;
import static org.hamcrest.CoreMatchers.notNullValue;
import static org.hamcrest.CoreMatchers.nullValue;
import static org.hamcrest.MatcherAssert.assertThat;
import static org.hamcrest.CoreMatchers.is;
import static org.hamcrest.CoreMatchers.notNullValue;
import static org.hamcrest.CoreMatchers.nullValue;
import static org.hamcrest.MatcherAssert.assertThat;
import static org.hamcrest.CoreMatchers.is;
import static org.hamcrest.CoreMatchers.notNullValue;
import static org.hamcrest.CoreMatchers.nullValue;
import static org.hamcrest.MatcherAssert.assertThat;
import static org.hamcrest.CoreMatchers.is;
import static org.hamcrest.CoreMatchers.notNullValue;
import static org.hamcrest.CoreMatchers.nullValue;
import static org.hamcrest.MatcherAssert.assertThat;
import static org.hamcrest.CoreMatchers.is;
import static org.hamcrest.CoreMatchers.notNullValue;
import static org.hamcrest.CoreMatchers.nullValue;
import static org.hamcrest.MatcherAssert.assertThat;
import static org.hamcrest.CoreMatchers.is;
import static org.hamcrest.CoreMatchers.notNullValue;
import static org.hamcrest.CoreMatchers.nullValue;
import static org.hamcrest.MatcherAssert.assertThat;
import static org.hamcrest.CoreMatchers.is;
import static org.hamcrest.CoreMatchers.notNullValue;
import static org.hamcrest.CoreMatchers.nullValue;
import static org.hamcrest.MatcherAssert.assertThat;
import static org.hamcrest.CoreMatchers.is;
import static org.hamcrest.CoreMatchers.notNullValue;
import static org.hamcrest.CoreMatchers.nullValue;
import static org.hamcrest.MatcherAssert.assertThat;
import static org.hamcrest.CoreMatchers.is;
import static org.hamcrest.CoreMatchers.notNullValue;
import static org.hamcrest.CoreMatchers.nullValue;
import static org.hamcrest.MatcherAssert.assertThat;
import static org.hamcrest.CoreMatchers.is;
import static org.hamcrest.CoreMatchers.notNullValue;
import static org.hamcrest.CoreMatchers.nullValue;
import static org.hamcrest.MatcherAssert.assertThat;
import static org.hamcrest.CoreMatchers.is;
import static org.hamcrest.CoreMatchers.notNullValue;
import static org.hamcrest.CoreMatchers.nullValue;
import static org.hamcrest.MatcherAssert.assertThat;
import static org.hamcrest.CoreMatchers.is;
import static org.hamcrest.CoreMatchers.notNullValue;
import static org.hamcrest.CoreMatchers.nullValue;
import static org.hamcrest.MatcherAssert.assertThat;

/**
 *
 * @author yecq
 */
public class JhhcJdbcMapCrudRepositoryTest extends Base {

    @Autowired
    private CrudRepositoryFactory factory;

    @Autowired
    private JdbcTemplate jdbc;

    @Test
    public void test_save() {
        this.expectedEx.expect(IllegalArgumentException.class);
        this.expectedEx.expectMessage("save的数据为空");
        CrudRepository repo = this.factory.getJdbcRepository("user");
        repo.save(new HashMap());
    }

    @Test
    public void test_save1() {
        this.expectedEx.expect(IllegalArgumentException.class);
        this.expectedEx.expectMessage("save的数据为空");
        CrudRepository repo = this.factory.getJdbcRepository("user");
        repo.save(new HashMap());
    }

    @Test
    public void test_save2() {
        CrudRepository<Map, String> repo = this.factory.getJdbcRepository("user");
        Map map = new HashMap();
        map.put("name", "京巴");
        map.put("age", 2);
        map = repo.save(map);
        int count = this.jdbc.queryForList("select * from user").size();
        assertThat(count, is(5));
        assertThat(map.get("id"), nullValue());
    }

    @Test
    public void test_save3() {
        CrudRepository repo = this.factory.getJdbcRepository("user");
        Map map = new HashMap();
        map.put("id", 1);
        map.put("name", "ABCD#");
        map.put("age", 200);
        repo.save(map);
        map = this.jdbc.queryForMap("select * from user where id=1");
        assertThat(map.get("id") + "", is("1"));
        assertThat(map.get("name") + "", is("ABCD#"));
        assertThat(Integer.parseInt(map.get("age") + ""), is(200));
    }

    @Test
    public void test_save_multi() {
        this.expectedEx.expect(IllegalArgumentException.class);
        this.expectedEx.expectMessage("save的数据为空");
        CrudRepository repo = this.factory.getJdbcRepository("user");
        repo.save(new HashMap());
    }

    @Test
    public void test_save_multi1() {
        CrudRepository<Map, String> repo = this.factory.getJdbcRepository("user");
        Map map1 = new HashMap();
        map1.put("name", "同学1");
        map1.put("age", 13);
        Map map2 = new HashMap();
        map2.put("name", "甲乙丙丁");
        map2.put("age", 23);
        Map map3 = new HashMap();
        map3.put("id", 2);
        map3.put("name", "ZXDF");
        map3.put("age", 1000);
        repo.save(asList(map1, map2, map3));

        int count = this.jdbc.queryForList("select * from user").size();
        assertThat(count, is(6));
        Map map = this.jdbc.queryForMap("select * from user where id=2");
        assertThat(map.get("id") + "", is("2"));
        assertThat(map.get("name") + "", is("ZXDF"));
        assertThat(Integer.parseInt(map.get("age") + ""), is(1000));
    }

    @Test
    public void test_findOne() {
        CrudRepository<Map, String> repo = this.factory.getJdbcRepository("user");
        Map map = (Map) repo.findOne("3");
        assertThat(map, notNullValue());
        assertThat(map.get("id") + "", is("3"));
        assertThat(map.get("name") + "", is("qindeyu"));
        assertThat(Integer.parseInt(map.get("age") + ""), is(21));

        map = repo.findOne("14");  // 这里的设计是找不到就返回null
        assertThat(map, nullValue());
    }

    @Test
    public void test_exists() {
        CrudRepository repo = this.factory.getJdbcRepository("user");
        assertThat(repo.exists("2"), is(true));
        assertThat(repo.exists("32"), is(false));
    }

    @Test
    public void test_findAll() {
        CrudRepository repo = this.factory.getJdbcRepository("user");
        Iterable<Map<String, Object>> data = repo.findAll();
        Iterator<Map<String, Object>> ite = data.iterator();
        int i = 0;
        while (ite.hasNext()) {
            i++;
            ite.next();
        }
        assertThat(i, is(4));
    }

    @Test
    public void test_findAll1() {
        CrudRepository repo = this.factory.getJdbcRepository("info");
        Iterable<Map<String, Object>> data = repo.findAll();
        assertThat(((List) data).size(), is(0));
    }

    @Test
    public void test_findAll2() {
        this.expectedEx.expect(IllegalArgumentException.class);
        this.expectedEx.expectMessage("find的列表参数为空");
        CrudRepository repo = this.factory.getJdbcRepository("user");
        repo.findAll(null);
    }

    @Test
    public void test_findAll3() {
        CrudRepository repo = this.factory.getJdbcRepository("user");
        Iterable<Map<String, Object>> tmp = repo.findAll(asList("2", "4"));
        List<Map<String, Object>> data = (List) tmp;
        assertThat(data.size(), is(2));
    }

    @Test
    public void test_findAll4() {
        CrudRepository repo = this.factory.getJdbcRepository("user");
        Iterable<Map<String, Object>> tmp = repo.findAll(asList("11", "13"));
        assertThat(((List) tmp).size(), is(0));
    }

    @Test
    public void test_count() {
        CrudRepository repo = this.factory.getJdbcRepository("user");
        assertThat(repo.count(), is(4L));

        repo = this.factory.getJdbcRepository("info");
        assertThat(repo.count(), is(0L));
    }

    @Test
    public void test_delete() {
        CrudRepository repo = this.factory.getJdbcRepository("user");
        repo.delete("3");
        List<Map<String, Object>> list = this.jdbc.queryForList("select * from user where id=3");
        assertThat(list.size(), is(0));
    }

    @Test
    public void test_delete1() {
        CrudRepository repo = this.factory.getJdbcRepository("user");
        Map map = new HashMap();
        map.put("name", "qindeyu");
        map.put("age", 21);
        repo.delete(map);
        List<Map<String, Object>> list = this.jdbc.queryForList("select * from user where name=? and age=?", "qindeyu", 21);
        assertThat(list.size(), is(0));
    }

    @Test
    public void test_delete2() {
        CrudRepository repo = this.factory.getJdbcRepository("user");
        Map map = new HashMap();
        map.put("name", "qindeyu");
        map.put("age", 23);
        repo.delete(map);
        List<Map<String, Object>> list = this.jdbc.queryForList("select * from user where name=? and age=?", "qindeyu", 21);
        assertThat(list.size(), is(1));
    }

    @Test
    public void test_delete3() {
        CrudRepository repo = this.factory.getJdbcRepository("user");
        Map map1 = new HashMap();
        map1.put("name", "qindeyu");
        map1.put("age", 21);

        Map map2 = new HashMap();
        map2.put("name", "abcd");
        map2.put("age", 11);
        repo.delete(asList(map1, map2));
        List<Map<String, Object>> list = this.jdbc.queryForList("select * from user where name=? and age=?", "qindeyu", 21);
        assertThat(list.size(), is(0));
        list = this.jdbc.queryForList("select * from user where name=? and age=?", "abcd", 11);
        assertThat(list.size(), is(0));
    }

    @Test
    public void test_deleteAll() {
        CrudRepository repo = this.factory.getJdbcRepository("user");
        repo.deleteAll();
        List<Map<String, Object>> list = this.jdbc.queryForList("select * from user where true");
        assertThat(list.size(), is(0));
    }
}
